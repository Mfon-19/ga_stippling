var C=Object.defineProperty;var E=(h,t,e)=>t in h?C(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var a=(h,t,e)=>E(h,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();const l={GENETIC:{DEFAULT_POPULATION_SIZE:100,DEFAULT_MUTATION_RATE:.2,ELITISM_RATIO:.7},IMAGE:{DEFAULT_BLUR:0,DEFAULT_THRESHOLD:130,MAX_DOT_COUNT:2e5}},d={MAIN:"canvas",IMAGE:"imgCanvas",BLACK_WHITE:"bwCanvas",EVOLUTION:"evolCanvas"};class v{constructor(){a(this,"mainCanvas");a(this,"imgCanvas");a(this,"bwCanvas");a(this,"evolCanvas");a(this,"mainCtx");a(this,"imgCtx");a(this,"bwCtx");a(this,"evolCtx");this.initializeCanvases()}initializeCanvases(){this.mainCanvas=document.getElementById(d.MAIN),this.imgCanvas=document.getElementById(d.IMAGE),this.bwCanvas=document.getElementById(d.BLACK_WHITE),this.evolCanvas=document.getElementById(d.EVOLUTION),this.mainCtx=this.getContext(this.mainCanvas,!0),this.imgCtx=this.getContext(this.imgCanvas),this.bwCtx=this.getContext(this.bwCanvas),this.evolCtx=this.getContext(this.evolCanvas)}getContext(t,e=!1){const i=t.getContext("2d",{willReadFrequently:e});if(!i)throw new Error("Failed to get canvas context");return i}resizeCanvases(t,e){[this.mainCanvas,this.imgCanvas,this.bwCanvas,this.evolCanvas].forEach(i=>{i.width=t,i.height=e})}getMainContext(){return this.mainCtx}getImageContext(){return this.imgCtx}getBWContext(){return this.bwCtx}getEvolContext(){return this.evolCtx}}class w{constructor(t,e,i){a(this,"ctx");a(this,"width");a(this,"height");this.ctx=t,this.width=e,this.height=i}convertToBlackAndWhite(t,e,i){const s=t.getImageData(0,0,this.width,this.height),n=s.data;return this.convertToGrayscale(n),this.applyBlur(n,e),this.applyThreshold(n,i),s}convertToGrayscale(t){for(let e=0;e<t.length;e+=4){const i=.299*t[e]+.587*t[e+1]+.114*t[e+2];t[e]=t[e+1]=t[e+2]=i}}applyBlur(t,e){if(e===0)return;const i=new Uint8ClampedArray(t.length);for(let s=0;s<this.height;s++)for(let n=0;n<this.width;n++){const o=this.calculateBlurredPixel(t,n,s,e),r=(s*this.width+n)*4;i[r]=o,i[r+1]=o,i[r+2]=o,i[r+3]=t[r+3]}for(let s=0;s<t.length;s++)t[s]=i[s]}calculateBlurredPixel(t,e,i,s){let n=0,o=0;for(let r=-s;r<=s;r++)for(let c=-s;c<=s;c++){const g=e+c,p=i+r;if(g>=0&&g<this.width&&p>=0&&p<this.height){const f=(p*this.width+g)*4;n+=t[f],o++}}return n/o}applyThreshold(t,e){for(let i=0;i<t.length;i+=4){const s=t[i]<e?0:255;t[i]=t[i+1]=t[i+2]=s}}calculateImageStats(t){const e=t.data,i=this.width*this.height;let s=0;for(let r=0;r<e.length;r+=4)e[r]===0&&s++;const n=s/i,o=Math.ceil(n*l.IMAGE.MAX_DOT_COUNT);return{blackPixels:s,totalPixels:i,blackPercentage:n,recommendedDotCount:o}}updateCanvas(t){this.ctx.putImageData(t,0,0)}clearCanvas(){this.ctx.clearRect(0,0,this.width,this.height)}resize(t,e){this.width=t,this.height=e}getDimensions(){return{width:this.width,height:this.height}}}class m{constructor(t,e,i){this.x=t,this.y=e,this.radius=i}clone(){return new m(this.x,this.y,this.radius)}}class u{constructor(t,e,i){a(this,"dots");a(this,"fitness");a(this,"width");a(this,"height");this.width=t,this.height=e,this.fitness=0,this.dots=this.initializeDots(i)}initializeDots(t){return Array.from({length:t},()=>new m(this.randX(),this.randY(),this.randRadius()))}mutate(t){this.dots.forEach(e=>{Math.random()<t&&(e.x=this.randX()),Math.random()<t&&(e.y=this.randY()),Math.random()<t&&(e.radius=this.randRadius())})}clone(){const t=new u(this.width,this.height,this.dots.length);return t.fitness=this.fitness,t.dots=this.dots.map(e=>e.clone()),t}randX(){return Math.floor(Math.random()*this.width)}randY(){return Math.floor(Math.random()*this.height)}randRadius(){return 1+Math.random()*2}}class I{constructor(t,e){a(this,"population");a(this,"targetData");a(this,"width");a(this,"height");this.width=t.width,this.height=t.height,this.population=this.initializePopulation(t),this.targetData=this.prepareTargetData(e)}initializePopulation(t){return Array.from({length:t.size},()=>new u(t.width,t.height,t.dotCount))}prepareTargetData(t){const e=t.width*t.height,i=new Uint8Array(e);for(let s=0;s<e;s++)i[s]=t.data[s*4];return i}calculateFitness(){this.population.forEach(t=>{const e=this.createGrid();this.drawDotsToGrid(t.dots,e),t.fitness=this.calculateGridFitness(e)})}createGrid(){return new Uint8Array(this.width*this.height).fill(255)}drawDotsToGrid(t,e){t.forEach(i=>{this.drawDotToGrid(i,e)})}drawDotToGrid(t,e){const i=Math.floor(t.x),s=Math.floor(t.y),n=Math.floor(t.radius);this.isOutsideCanvas(i,s,n)||this.drawCircle(i,s,n,e)}isOutsideCanvas(t,e,i){return t+i<0||t-i>=this.width||e+i<0||e-i>=this.height}drawCircle(t,e,i,s){let n=0,o=i,r=1-i;for(this.drawHorizontalLine(e,t-i,t+i,s);o>n;)r<0?r+=2*n+3:(r+=2*(n-o)+5,o--),n++,this.drawHorizontalLine(e+o,t-n,t+n,s),this.drawHorizontalLine(e-o,t-n,t+n,s),this.drawHorizontalLine(e+n,t-o,t+o,s),this.drawHorizontalLine(e-n,t-o,t+o,s)}drawHorizontalLine(t,e,i,s){if(!(t<0||t>=this.height)){e=Math.max(0,e),i=Math.min(this.width-1,i);for(let n=e;n<=i;n++)s[t*this.width+n]=0}}calculateGridFitness(t){const e=this.width*this.height;let i=0;for(let o=0;o<e;o++){const r=t[o]-this.targetData[o];i+=r*r}const s=e*255*255,n=1-i/s;return Math.pow(n,.5)}getFittestIndex(){return this.population.reduce((t,e,i,s)=>e.fitness>s[t].fitness?i:t,0)}drawIndividual(t,e){e.clearRect(0,0,this.width,this.height),e.fillStyle="white",e.fillRect(0,0,this.width,this.height),e.fillStyle="black",t.forEach(i=>{e.beginPath(),e.arc(i.x,i.y,i.radius,0,2*Math.PI),e.fill()})}}class D{constructor(t,e){a(this,"population");a(this,"config");a(this,"target");this.target=t,this.config=e;const i={size:e.populationSize,width:t.width,height:t.height,dotCount:e.dotCount};this.population=new I(i,t)}evolve(){this.population.calculateFitness(),console.log("Fittest Individual's fitness score: ",this.population.population[this.population.getFittestIndex()].fitness),this.createNewGeneration()}createNewGeneration(){const t=Math.floor(this.config.populationSize*this.config.elitismRatio),e=this.preserveElites(t);for(;e.length<this.config.populationSize;){const{parent1:i,parent2:s}=this.selectParents(),n=this.crossover(i,s);n.mutate(this.config.mutationRate),e.push(n)}this.population.population=e}preserveElites(t){return[...this.population.population].sort((e,i)=>i.fitness-e.fitness).slice(0,t).map(e=>e.clone())}selectParents(){const t=this.population.population.reduce((i,s)=>i+s.fitness,0),e=()=>{let i=Math.random()*t,s=0;for(const n of this.population.population)if(s+=n.fitness,s>=i)return n;return this.population.population[this.population.population.length-1]};return{parent1:e(),parent2:e()}}crossover(t,e){const i=new u(this.target.width,this.target.height,t.dots.length);for(let s=0;s<t.dots.length;s++){const n=this.calculateDotFitness(t.dots[s]),o=this.calculateDotFitness(e.dots[s]);i.dots[s]=(n>o?t:e).dots[s].clone()}return i}calculateDotFitness(t){const e=Math.floor(t.x),i=Math.floor(t.y);if(e<0||e>=this.target.width||i<0||i>=this.target.height)return 0;const s=(i*this.target.width+e)*4;return 255-this.target.data[s]}getPopulation(){return this.population}}class x{constructor(t,e){a(this,"canvasManager");a(this,"imageProcessor");a(this,"elements");a(this,"state");this.canvasManager=t,this.imageProcessor=new w(this.canvasManager.getBWContext(),0,0),this.elements=e,this.state={currentImage:null,geneticAlgorithm:null,isEvolutionRunning:!1,generations:0,recommendedDotCount:0},this.initializeEventListeners()}initializeEventListeners(){this.elements.fileInput.addEventListener("change",this.handleFileInput.bind(this)),this.elements.blurSlider.addEventListener("input",this.handleBlurChange.bind(this)),this.elements.thresholdSlider.addEventListener("input",this.handleThresholdChange.bind(this)),this.elements.dotCountInput.addEventListener("change",this.handleDotCountChange.bind(this)),this.elements.startButton.addEventListener("click",this.handleStartEvolution.bind(this)),this.elements.stopButton.addEventListener("click",this.handleStopEvolution.bind(this))}async handleFileInput(t){var s;const i=(s=t.target.files)==null?void 0:s[0];if(i)try{const n=await this.loadImage(i);this.state.currentImage=n,this.canvasManager.resizeCanvases(n.width,n.height),this.imageProcessor.resize(n.width,n.height),this.canvasManager.getImageContext().drawImage(n,0,0),this.processImage()}catch(n){console.error("Error loading image:",n)}}loadImage(t){return new Promise((e,i)=>{const s=new FileReader,n=new Image;s.onload=o=>{var r;n.onload=()=>e(n),n.onerror=()=>i(new Error("Failed to load image")),n.src=(r=o.target)==null?void 0:r.result},s.onerror=()=>i(new Error("Failed to read file")),s.readAsDataURL(t)})}handleBlurChange(t){const e=parseInt(t.target.value);this.elements.blurValueDisplay.textContent=e.toString(),this.processImage()}handleThresholdChange(t){const e=parseInt(t.target.value);this.elements.thresholdValueDisplay.textContent=e.toString(),this.processImage()}handleDotCountChange(t){const e=parseInt(t.target.value);this.state.recommendedDotCount=e,this.updateDotCountDisplay()}processImage(){if(!this.state.currentImage)return;const t=parseInt(this.elements.blurSlider.value),e=parseInt(this.elements.thresholdSlider.value),i=this.imageProcessor.convertToBlackAndWhite(this.canvasManager.getImageContext(),t,e);this.canvasManager.getBWContext().putImageData(i,0,0);const n=this.imageProcessor.calculateImageStats(i);this.state.recommendedDotCount=n.recommendedDotCount,this.elements.dotCountElement.style.display="block",this.elements.dotCountInput.style.display="block",this.updateDotCountDisplay()}updateDotCountDisplay(){this.elements.dotCountElement.textContent=`Recommended dot count: ${this.state.recommendedDotCount}`+(this.state.generations?`. Generations: ${this.state.generations}`:""),this.elements.dotCountInput.value=this.state.recommendedDotCount.toString()}handleStartEvolution(){if(this.state.isEvolutionRunning||!this.state.currentImage)return;const e=this.canvasManager.getBWContext().getImageData(0,0,this.state.currentImage.width,this.state.currentImage.height);this.state.geneticAlgorithm=new D(e,{populationSize:l.GENETIC.DEFAULT_POPULATION_SIZE,mutationRate:l.GENETIC.DEFAULT_MUTATION_RATE,dotCount:this.state.recommendedDotCount,elitismRatio:l.GENETIC.ELITISM_RATIO}),this.state.isEvolutionRunning=!0,this.state.generations=0,this.updateUIState(!0),this.startEvolutionLoop()}startEvolutionLoop(){const t=()=>{if(!this.state.isEvolutionRunning||!this.state.geneticAlgorithm)return;this.state.geneticAlgorithm.evolve(),this.state.generations++,this.updateDotCountDisplay();const e=this.canvasManager.getEvolContext(),i=this.state.geneticAlgorithm.getPopulation(),s=i.getFittestIndex();i.drawIndividual(i.population[s].dots,e),this.state.animationFrameId=requestAnimationFrame(t)};t()}stopEvolution(){this.state.isEvolutionRunning=!1,this.state.animationFrameId&&cancelAnimationFrame(this.state.animationFrameId)}updateUIState(t){this.elements.startButton.disabled=t,this.elements.stopButton.disabled=!t,this.elements.fileInput.disabled=t,this.elements.blurSlider.disabled=t,this.elements.thresholdSlider.disabled=t,this.elements.dotCountInput.disabled=t,document.body.classList.toggle("evolution-running",t)}handleStopEvolution(){this.stopEvolution(),this.updateUIState(!1)}dispose(){this.stopEvolution(),this.updateUIState(!1)}}class y{constructor(){a(this,"canvasManager");a(this,"eventHandlers");this.initializeApp()}initializeApp(){try{this.canvasManager=new v;const t=this.getUIElements();this.eventHandlers=new x(this.canvasManager,t),this.setInitialUIState(t),this.setupWindowListeners()}catch(t){this.handleInitializationError(t)}}getUIElements(){const t={dotCountElement:this.getRequiredElement("recommendedDotCount"),dotCountInput:this.getRequiredElement("dotCountInput"),blurSlider:this.getRequiredElement("blurAmount"),thresholdSlider:this.getRequiredElement("threshold"),blurValueDisplay:this.getRequiredElement("blurValue"),thresholdValueDisplay:this.getRequiredElement("thresholdValue"),fileInput:this.getRequiredElement("imgInput"),startButton:this.getRequiredElement("start"),stopButton:this.getRequiredElement("stop")};return this.validateUIElements(t),t}getRequiredElement(t){const e=document.getElementById(t);if(!e)throw new Error(`Required UI element not found: ${t}`);return e}validateUIElements(t){if(!(t.dotCountInput instanceof HTMLInputElement))throw new Error("dotCountInput must be an input element");if(!(t.blurSlider instanceof HTMLInputElement))throw new Error("blurSlider must be an input element");if(!(t.thresholdSlider instanceof HTMLInputElement))throw new Error("thresholdSlider must be an input element");if(!(t.fileInput instanceof HTMLInputElement))throw new Error("fileInput must be an input element")}setInitialUIState(t){t.blurSlider.value=l.IMAGE.DEFAULT_BLUR.toString(),t.thresholdSlider.value=l.IMAGE.DEFAULT_THRESHOLD.toString(),t.blurValueDisplay.textContent=l.IMAGE.DEFAULT_BLUR.toString(),t.thresholdValueDisplay.textContent=l.IMAGE.DEFAULT_THRESHOLD.toString(),t.dotCountElement.style.display="none",t.dotCountInput.style.display="none"}setupWindowListeners(){window.addEventListener("unload",()=>{this.cleanup()}),window.addEventListener("error",t=>{this.handleError(t.error)})}handleInitializationError(t){console.error("Failed to initialize application:",t);const e=t instanceof Error?t.message:"Unknown error occurred";this.showErrorMessage(e)}handleError(t){console.error("Runtime error:",t),this.showErrorMessage(t.message)}showErrorMessage(t){alert(`An error occurred: ${t}`)}cleanup(){this.eventHandlers&&this.eventHandlers.dispose()}}document.addEventListener("DOMContentLoaded",()=>{new y});window.addEventListener("beforeunload",h=>{document.querySelector(".evolution-running")&&h.preventDefault()});
